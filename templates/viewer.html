<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Viewer</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
    	body {
    		background-color: black;
    	}
    	
        .message-container {
            background: #ced4da;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Subtle shadow */
            margin-bottom: 10px;
            padding: 15px;
        }

        .message {
            font-size: 3rem; /* Large font size for messages */
        }

        .latest-message {
            background-color: #e6f7ff; /* Light blue background for the latest message */
            border: 2px solid #007BFF; /* Blue border */
            font-weight: bold; /* Make the latest message bold */
        }
        
        .message-details {
            font-size: 1.2rem;
            color: #888;
        }

        .divider {
            height: 1px; 
            background-color: #e0e0e0; 
            margin: 20px 0; 
        }
        
        .reply-container {
	        margin-left: 20px; /* Indent replies */
	        padding-left: 10px;
	        border-left: 2px dotted darkgray;
	    }
	    
	    .reply {
	        font-size: 1.2rem;
	    }
	    
	    .reply-button {
	        margin-left: 5px;
	    }
	    
	    #topBar {
	    	z-index: 1000;
	    	background-color: black;
	    }
	    
	    #clock {
	        font-size: 4rem; /* Large font size for the clock */
	        font-weight: bold; /* Make the latest message bold */
	    }
    </style>
</head>
<body>
    <div class="container-fluid mt-5">
    	{% if arg_edit or arg_clock %}
    	<!-- Top bar -->
    	<div id="topBar" class="container-fluid d-flex flex-wrap justify-content-between align-items-center fixed-top border-bottom">
    		<div>
    			{%if arg_edit %}
    			<!-- Send new message button -->
    			<button id="btnSendMessage" class="btn btn-lg btn-info">&#128172;</button>
    			{% endif %}
    		</div>	
    		
    		{% if arg_clock %}
    		<!-- Clock -->
    		<div id="clock" class="text-light text-center"></div>
    		{% endif %}
    		
    		<div>
    			{%if arg_edit %}
    			<!-- Clear messages button -->
    			<button id="btnClearMessages" class="btn btn-lg btn-danger reply-button">Clear</button>
    			{% endif %}
    		</div>
    	</div>
    	{% endif %}
    	
    	<!-- Message Container -->
    	<div id="messageDisplayContainer" class="mt-5 pt-5">
    		<div class="mt-3"></div>
	        <ul id="messageDisplay" class="list-unstyled">
	            <!-- Messages will be dynamically inserted here -->
	        </ul>
	    </div>
    </div>
    
    
    <!-- Modal for entering message text -->
	<div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <form id="messageForm"> <!-- Start Form -->
	                <div class="modal-header">
	                    <h5 class="modal-title" id="messageModalLabel">Send a Message</h5>
	                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                        <span aria-hidden="true">&times;</span>
	                    </button>
	                </div>
	                <div class="modal-body">
	                    <textarea name="message" class="form-control" rows="3" placeholder="Write your message here...&#10;Press ENTER to send&#10;Press SHIFT+ENTER to add a new line" required></textarea>
	                </div>
	                <div class="modal-footer">
	                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
	                    <button type="submit" class="btn btn-primary">Send</button> <!-- Submit button -->
	                </div>
	            </form> <!-- End Form -->
	        </div>
	    </div>
	</div>
    
    <!-- Modal for entering reply text -->
	<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="commentModalLabel">Add a Reply</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <textarea id="message" class="form-control" rows="3" placeholder="Write your reply here..."></textarea>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
	                <button type="button" class="btn btn-primary" id="submitComment">Reply</button>
	            </div>
	        </div>
	    </div>
	</div>

    <script src="{{ url_for('static', filename='js/jquery.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script>
        const N = {{ arg_n }};
        const viewerName = "{{ arg_name }}";
        const refreshRateMs = {{ arg_refresh }};
        
        function updateClock() {
	        const now = new Date();
	        let hours = now.getHours();
	        const minutes = now.getMinutes().toString().padStart(2, '0');
	        const seconds = now.getSeconds().toString().padStart(2, '0');
	        
	        // Determine AM or PM suffix
	        const amPm = hours >= 12 ? 'PM' : 'AM';

	        // Convert 24-hour time format to 12-hour time format
	        hours = hours % 12;
	        hours = hours ? hours : 12; // The hour '0' should be '12'

	        const timeString = `${hours}:${minutes}:${seconds} ${amPm}`;
	        $('#clock').text(timeString);
	    }
	    
	    /**
	    * @brief Send a new message
	    */
	    function sendMessage(message, name = null) {
		    return new Promise((resolve, reject) => {
		        if (!message) {
		            reject('Message is empty');
		            return;
		        }

		        // Construct the payload object
		        const payload = { message };
		        if (name) {
		            payload.name = name;
		        }

		        // Use the relative URL to post message data to the server
		        const url = '/display';

		        fetch(url, {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		            },
		            body: JSON.stringify(payload),
		        })
		            .then(response => {
		                if (response.ok) {
		                    resolve(); // The message was successfully sent
		                } else {
		                    reject('Failed to send the message');
		                }
		            })
		            .catch(error => {
		                console.error('Error:', error);
		                reject(error);
		            });
		    });
		}
		
		/**
		* @brief Clear all messages
		*/
		function clearMessages() {
			return new Promise((resolve, reject) => {
	            // Send a POST request to the server to clear all messages
	            fetch('/clear', {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json',
	                },
	            })
	            .then(response => {
	                if (response.ok) {
	                   resolve();
	                } else {
	                    reject('Failed to clear messages.');
	                }
	            })
	            .catch(error => {
	                console.error('Error:', error);
	                reject(error);
	            });
	        });
        }
        
        // New function to handle replying to messages
	    function replyToMessage(messageId, replyText) {
	    	var payload = {};
	    	if (viewerName) payload.name = viewerName;
	    	payload.messageId = messageId;
	    	payload.message = replyText;
	    	
	        fetch('/reply', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify(payload)
	        })
	        .then(response => response.json())
	        .then(() => loadMessages())
	        .catch(error => console.error('Error:', error));
	    }

		// Fetch and display messages from the server
		function loadMessages() {
        fetch(`/display?N=${N}`)
            .then(response => response.json())
            .then(data => {
                const messageDisplay = $('#messageDisplay');
                messageDisplay.empty();

                data.messages.reverse().forEach(({ id, name, message, timestamp, replies }, index) => {
                    const messageCard = $('<div class="message-container mb-3"></div>');

                    if (index === 0) {
                        messageCard.addClass('latest-message');
                    }

                    const messageElement = $('<p class="message"></p>').text(message);
                    messageCard.append(messageElement);
                    
                    const nameTimestampContainer = $('<div class="message-details"></div>').text(`- ${name}, ${timestamp}`);

                    // Add interaction buttons
                    const buttonGroup = $('<div class="reply-button-group"></div>');
                    const thumbsUp = $('<button class="btn btn-lg btn-success reply-button">&#128077;</button>').click(() => replyToMessage(id, 'üëç'));
                    const thumbsDown = $('<button class="btn btn-lg btn-danger reply-button">&#128078;</button>').click(() => replyToMessage(id, 'üëé'));
                    const comment = $('<button class="btn btn-lg btn-info reply-button">&#128172;</button>').click(() => {
                        $('#commentModal').data('message-id', id).modal('show');
                    });
                    
                    buttonGroup.append(thumbsUp, thumbsDown, comment);
                    
                    const detailsContainer = $('<p class="d-flex flex-wrap justify-content-between"></p>');
                    detailsContainer.append(buttonGroup, nameTimestampContainer);
                    messageCard.append(detailsContainer);
                    
                    // Display any existing replies
                    replies.forEach(({ name, message, timestamp }) => {
                        const replyContainer = $('<div class="reply-container"></div>');
                        const replyElement = $('<p class="reply d-flex flex-wrap justify-content-between"></p>');
                        const replyMessage = $('<span class=""></span>').text(message);
                        const replyDetails = $('<span class="reply-details text-muted"></span>').text(`- ${name}, ${timestamp}`);
                        replyElement.append(replyMessage, replyDetails);
                        replyContainer.append(replyElement);
                        messageCard.append(replyContainer);
                    });

                    const divider = $('<div class="divider"></div>');
                    messageDisplay.append(messageCard, divider);
                });
            })
            .catch(error => console.error('Error:', error));
    	}

		// Call the function immediately when the page loads
		$(document).ready(function() {	
			{% if arg_clock %}
			updateClock();  // Display current time
	        setInterval(updateClock, 1000);  // Update every second
	        {% endif %}

	        // Event listender to show new message modal
	        $('#btnSendMessage').on('click', function() {
	        	$('#messageModal').modal('show');
	        });
	        
	        // Handle enter events in message form text area
	        $('#messageForm [name="message"]').keypress(function (event) {
	        	console.log("EVENT");
	            // Check if Enter is pressed without Shift
	            if (event.which === 13 && !event.shiftKey) {
	                event.preventDefault(); // Prevent adding a newline
	                $('#messageForm').submit();
	            }
	        });
			
			// Event listener for new message submission
		    $('#messageForm').on('submit', function(event) {
		    	event.preventDefault(); // Prevent the default form submission behavior (i.e., page reload)
		    	
		        const message = $(this).find('[name="message"]').val();
		        
		        sendMessage(message, viewerName).then(() => {
		        	loadMessages();
		        	$('#messageModal').modal('hide');
		        }).catch(error => {
		        	alert("Error sending message: " + error)
		        	console.error("Error sending message: ", error);
		        });
		    });
		    
		    // Event listener for when the message modal is closed
		    $('#messageModal').on('hide.bs.modal', function() {
		        $('#messageForm [name="message"]').val('');
		    });

		    // Event listener for comment submission
		    $('#submitComment').on('click', function() {
		        const commentText = $('#commentText').val();
		        const messageId = $('#commentModal').data('message-id');
		        
		        replyToMessage(messageId, commentText);
		        
		        $('#commentModal').modal('hide');
		    });
		    
		    // Event listener for when the comment modal is closed
		    $('#commentModal').on('hide.bs.modal', function() {
		        $('#commentText').val(''); // Clear the text area
		    });
		    
		    $('#btnClearMessages').on('click', function(){
		    	if (confirm('Are you sure you want to clear all messages? This action cannot be undone!')) {
		    	 	clearMessages().then(() => {
		    	 		loadMessages();
		    	 	}).catch(error => {
		    	 		alert("Error clearning message: " + error);
		        		console.error("Error clearing message: ", error);
		    		});
		    	}
		    });
			
		    loadMessages();

		    // Fetch messages periodically (if enabled)
		    if (refreshRateMs > 0)
		    {
		    	console.log("Auto refresh every " + refreshRateMs + "ms");
		    	setInterval(loadMessages, refreshRateMs);
		    }
		});
    </script>
</body>
</html>