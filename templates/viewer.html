<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Viewer</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
    	body {
    		background-color: black;
    	}
    	
        .message-container {
            background: #ced4da;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Subtle shadow */
            margin-bottom: 10px;
            padding: 15px;
        }

        .message {
            font-size: 3rem; /* Large font size for messages */
        }

        .latest-message {
            background-color: #e6f7ff; /* Light blue background for the latest message */
            border: 2px solid #007BFF; /* Blue border */
            font-weight: bold; /* Make the latest message bold */
        }
        
        .message-details {
            font-size: 1.2rem;
            color: #888;
        }

        .divider {
            height: 1px; 
            background-color: #e0e0e0; 
            margin: 20px 0; 
        }
        
        .reply-container {
	        margin-left: 20px; /* Indent replies */
	        padding-left: 10px;
	        border-left: 2px dotted darkgray;
	    }
	    
	    .reply {
	        font-size: 1.2rem;
	    }
	    
	    .reply-button {
	        margin-left: 5px;
	    }
	    
	    #clock {
	    	background-color: black;
	        font-size: 4rem; /* Large font size for the clock */
	        text-align: center; /* Center the clock text */
	        margin-bottom: 20px; /* Add some space below the clock */
	        font-weight: bold; /* Make the latest message bold */
	    }
    </style>
</head>
<body>
    <div class="container-fluid mt-5">
    	<div id="clock" class="text-light text-center fixed-top" style="z-index: 1000;"></div> <!-- Clock container -->
    	<div id="messageDisplayContainer" class="mt-5 pt-5">
	        <ul id="messageDisplay" class="list-unstyled">
	            <!-- Messages will be dynamically inserted here -->
	        </ul>
	    </div>
    </div>
    
    <!-- Modal for entering comments -->
	<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="commentModalLabel">Add a Reply</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <textarea id="commentText" class="form-control" rows="3" placeholder="Write your reply here..."></textarea>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
	                <button type="button" class="btn btn-primary" id="submitComment">Send</button>
	            </div>
	        </div>
	    </div>
	</div>

    <script src="{{ url_for('static', filename='js/jquery.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script>
        // Function to extract parameters from the URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Get the number of messages (N) from URL parameters
        const N = parseInt(getQueryParam('N')) || 3;
        const viewerName = getQueryParam('name');
        const refreshRateMs = getQueryParam('refresh') !== null ? parseInt(getQueryParam('refresh')) : 3000;
        
        function updateClock() {
	        const now = new Date();
	        let hours = now.getHours();
	        const minutes = now.getMinutes().toString().padStart(2, '0');
	        const seconds = now.getSeconds().toString().padStart(2, '0');
	        
	        // Determine AM or PM suffix
	        const amPm = hours >= 12 ? 'PM' : 'AM';

	        // Convert 24-hour time format to 12-hour time format
	        hours = hours % 12;
	        hours = hours ? hours : 12; // The hour '0' should be '12'

	        const timeString = `${hours}:${minutes}:${seconds} ${amPm}`;
	        $('#clock').text(timeString);
	    }
        
        // New function to handle replying to messages
	    function replyToMessage(messageId, replyText) {
	    	var payload = {};
	    	if (viewerName) payload.name = viewerName;
	    	payload.messageId = messageId;
	    	payload.message = replyText;
	    	
	        fetch('/reply', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify(payload)
	        })
	        .then(response => response.json())
	        .then(() => loadMessages())
	        .catch(error => console.error('Error:', error));
	    }

	    // Event listener for comment submission
	    $('#submitComment').on('click', function() {
	        const commentText = $('#commentText').val();
	        const messageId = $('#commentModal').data('message-id');
	        
	        replyToMessage(messageId, commentText);
	        
	        $('#commentModal').modal('hide');
	        document.getElementById('commentText').value = "";
	    });
	    
	    // Event listener for when the comment modal is closed
	    $('#commentModal').on('hide.bs.modal', function() {
	        $('#commentText').val(''); // Clear the text area
	    });

		// Fetch and display messages from the server
		function loadMessages() {
        fetch(`/display?N=${N}`)
            .then(response => response.json())
            .then(data => {
                const messageDisplay = $('#messageDisplay');
                messageDisplay.empty();

                data.messages.reverse().forEach(({ id, name, message, timestamp, replies }, index) => {
                    const messageCard = $('<div class="message-container mb-3"></div>');

                    if (index === 0) {
                        messageCard.addClass('latest-message');
                    }

                    const messageElement = $('<p class="message"></p>').text(message);
                    messageCard.append(messageElement);
                    
                    const nameTimestampContainer = $('<div class="message-details"></div>').text(`- ${name}, ${timestamp}`);

                    // Add interaction buttons
                    const buttonGroup = $('<div class="reply-button-group"></div>');
                    const thumbsUp = $('<button class="btn btn-lg btn-success reply-button">&#128077;</button>').click(() => replyToMessage(id, 'üëç'));
                    const thumbsDown = $('<button class="btn btn-lg btn-danger reply-button">&#128078;</button>').click(() => replyToMessage(id, 'üëé'));
                    const comment = $('<button class="btn btn-lg btn-info reply-button">&#128172;</button>').click(() => {
                        $('#commentModal').data('message-id', id).modal('show');
                    });
                    
                    buttonGroup.append(thumbsUp, thumbsDown, comment);
                    
                    const detailsContainer = $('<p class="d-flex flex-wrap justify-content-between"></p>');
                    detailsContainer.append(buttonGroup, nameTimestampContainer);
                    messageCard.append(detailsContainer);
                    
                    // Display any existing replies
                    replies.forEach(({ name, message, timestamp }) => {
                        const replyContainer = $('<div class="reply-container"></div>');
                        const replyElement = $('<p class="reply d-flex flex-wrap justify-content-between"></p>');
                        const replyMessage = $('<span class=""></span>').text(message);
                        const replyDetails = $('<span class="reply-details text-muted"></span>').text(`- ${name}, ${timestamp}`);
                        replyElement.append(replyMessage, replyDetails);
                        replyContainer.append(replyElement);
                        messageCard.append(replyContainer);
                    });

                    const divider = $('<div class="divider"></div>');
                    messageDisplay.append(messageCard, divider);
                });
            })
            .catch(error => console.error('Error:', error));
    	}

		// Call the function immediately when the page loads
		$(document).ready(function() {
			const showClock = getQueryParam('clock') === 'true';
			
			if (showClock) {
	            $('#clock').show();  // Show the clock
	            updateClock();  // Display current time
	            setInterval(updateClock, 1000);  // Update every second
	        } else {
	        	$('#messageDisplayContainer').removeClass('mt-5 pt-5'); //Remove extra space above message container if clock disabled
	            $('#clock').hide();  // Hide the clock if parameter is not set or false
	        }
			
		    loadMessages();

		    // Fetch messages periodically (if enabled)
		    if (refreshRateMs > 0)
		    {
		    	console.log("Auto refresh every " + refreshRateMs + "ms");
		    	setInterval(loadMessages, refreshRateMs);
		    }
		});
    </script>
</body>
</html>