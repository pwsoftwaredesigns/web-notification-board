<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Viewer</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
    	body {
    		background-color: black;
    	}
    	
        .message-container {
            background: #ced4da;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Subtle shadow */
            margin-bottom: 10px;
            padding: 15px;
        }

        .message {
            font-size: 2rem; /* Large font size for messages */
        }

        .latest-message {
            background-color: #e6f7ff; /* Light blue background for the latest message */
            border: 2px solid #007BFF; /* Blue border */
            font-weight: bold; /* Make the latest message bold */
        }
        
        .message-name {
            font-size: 1.2rem; /* Smaller font size for timestamps */
            color: #888; /* Subtle color for timestamps */
            text-align: right;
        }

        .timestamp {
            font-size: 1.2rem; /* Smaller font size for timestamps */
            color: #888; /* Subtle color for timestamps */
            text-align: right; 
        }

        .divider {
            height: 1px; 
            background-color: #e0e0e0; 
            margin: 20px 0; 
        }
        
        .reply-container {
	        margin-left: 20px; /* Indent replies */
	        padding-left: 10px;
	        border-left: 2px dotted darkgray;
	    }
	    
	    .reply {
	        font-size: 1.2rem;
	    }
	    
	    .reply-button {
	        margin-left: 5px;
	    }
    </style>
</head>
<body>
    <div class="container mt-5">
        <ul id="messageDisplay" class="list-unstyled">
            <!-- Messages will be dynamically inserted here -->
        </ul>
    </div>
    
    <!-- Modal for entering comments -->
	<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
	    <div class="modal-dialog" role="document">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="commentModalLabel">Add a Comment</h5>
	                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                    <span aria-hidden="true">&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <textarea id="commentText" class="form-control" rows="3" placeholder="Write your comment here..."></textarea>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
	                <button type="button" class="btn btn-primary" id="submitComment">Submit Comment</button>
	            </div>
	        </div>
	    </div>
	</div>

    <script src="{{ url_for('static', filename='js/jquery.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script>
        // Function to extract parameters from the URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Get the number of messages (N) from URL parameters
        const N = parseInt(getQueryParam('N')) || 3;
        const viewerName = getQueryParam('name'); 
        
        // New function to handle replying to messages
	    function replyToMessage(messageId, replyText) {
	    	var payload = {};
	    	if (viewerName) payload.name = viewerName;
	    	payload.messageId = messageId;
	    	payload.message = replyText;
	    	
	        fetch('/reply', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify(payload)
	        })
	        .then(response => response.json())
	        .then(() => loadMessages())
	        .catch(error => console.error('Error:', error));
	    }

	    // Event listener for comment submission
	    document.getElementById('submitComment').addEventListener('click', function() {
	        const commentText = document.getElementById('commentText').value;
	        const messageId = $('#commentModal').data('message-id');
	        replyToMessage(messageId, commentText);
	        $('#commentModal').modal('hide');
	    });

		// Fetch and display messages from the server
		function loadMessages() {
        fetch(`/display?N=${N}`)
            .then(response => response.json())
            .then(data => {
                const messageDisplay = $('#messageDisplay');
                messageDisplay.empty();

                data.messages.reverse().forEach(({ id, name, message, timestamp, replies }, index) => {
                    const messageCard = $('<div class="message-container mb-3"></div>');

                    if (index === 0) {
                        messageCard.addClass('latest-message');
                    }

                    const messageElement = $('<p class="message"></p>').text(message);
                    messageCard.append(messageElement);

                    const nameTimestampContainer = $('<div class="d-flex justify-content-between align-items-center"></div>');
                    const nameElement = $('<p class="message-name mb-0"></p>').text(name);
                    const timestampElement = $('<p class="timestamp mb-0"></p>').text(timestamp);
                    nameTimestampContainer.append(nameElement, timestampElement);
                    messageCard.append(nameTimestampContainer);

                    // Add interaction buttons
                    const buttonGroup = $('<div class="reply-button-group"></div>');
                    const thumbsUp = $('<button class="btn btn-sm btn-success reply-button">&#128077;</button>').click(() => replyToMessage(id, 'üëç'));
                    const thumbsDown = $('<button class="btn btn-sm btn-danger reply-button">&#128078;</button>').click(() => replyToMessage(id, 'üëé'));
                    const comment = $('<button class="btn btn-sm btn-info reply-button">&#128172;</button>').click(() => {
                        $('#commentModal').data('message-id', id).modal('show');
                    });
                    
                    buttonGroup.append(thumbsUp, thumbsDown, comment);
                    messageCard.append(buttonGroup);

                    // Display any existing replies
                    replies.forEach(({ name, message, timestamp }) => {
                        const replyContainer = $('<div class="reply-container"></div>');
                        const replyElement = $('<p class="reply"></p>').text(message);
                        const replyDetails = $('<span class="reply-details float-right text-muted"></span>').text(`- ${name}, ${timestamp}`);
                        replyElement.append(replyDetails);
                        replyContainer.append(replyElement);
                        messageCard.append(replyContainer);
                    });

                    const divider = $('<div class="divider"></div>');
                    messageDisplay.append(messageCard, divider);
                });
            })
            .catch(error => console.error('Error:', error));
    	}

		// Call the function immediately when the page loads
		$(document).ready(function() {
		    loadMessages();

		    // Fetch messages periodically (every 3 seconds)
		    setInterval(loadMessages, 3000);
		});
    </script>
</body>
</html>